import groovy.json.JsonSlurper
import groovy.xml.XmlSlurper
import groovy.json.JsonOutput

def extractFieldsFromXmlResponse(String xmlResponse) {
    // Initialize ALL required fields with empty strings - GUARANTEED to have all fields
    def resultMap = [
        'ceasedate': '',
        'reduced face value': '',
        'maturity date.': '',
        'CA LTC Rider': '',
        'Interest rate': '',
        'withdrawal Amount': '',
        'email Address': '',
        'anniversaryDate': '',
        'effectiveDate': '',
        'deathBenfitAmount': '',
        'terminationDate': '',
        'ceaseDate': '',
        'policyStatus': '',
        'cashValue': '',
        'surrenderValue': '',
        'LastPaymentDate': '',
        'LastPaymentAmount': '',
        'PaidToDate': '',
        'PremiumAmount': '',
        'billingFrequency': '',
        'directBillingMode': '',
        'premiumDueDate': '',
        'API for user authentication verification': '',
        'email address': '',
        'address': '',
        'PaymentAmount': '',
        'premiumAmount': ''
    ]
    
    try {
        // Convert XML to JSON
        def xml = new XmlSlurper().parseText(xmlResponse)
        def jsonString = JsonOutput.toJson(xml)
        def json = new JsonSlurper().parseText(jsonString)
        
        // Navigate to common sections
        def policy = json?.TXLifeResponse?.OLifE?.Holding?.Policy
        def life = policy?.Life
        def coverage = life?.Coverage
        def userAuth = json?.UserAuthResponse
        
        // Find parties
        def parties = json?.TXLifeResponse?.OLifE?.Party
        def party3 = parties?.find { it.'@id' == 'Party_3' }
        def emailParty = parties?.find { it.EMailAddress != null }
        
        // Extract fields - only update if value exists
        if (policy?.EffDate) {
            resultMap['effectiveDate'] = policy.EffDate.toString()
        }
        
        if (coverage?.DeathBenefitAmt) {
            resultMap['deathBenfitAmount'] = coverage.DeathBenefitAmt.toString()
        }
        
        if (policy?.PolicyStatus) {
            resultMap['policyStatus'] = policy.PolicyStatus.toString()
        }
        
        if (life?.CashValueAmt) {
            resultMap['cashValue'] = life.CashValueAmt.toString()
        }
        
        if (life?.NetSurrValueAmt) {
            resultMap['surrenderValue'] = life.NetSurrValueAmt.toString()
        }
        
        if (life?.LastPremDate) {
            resultMap['LastPaymentDate'] = life.LastPremDate.toString()
        }
        
        if (life?.LastPremAmt) {
            def amount = life.LastPremAmt.toString()
            resultMap['LastPaymentAmount'] = amount
            resultMap['PremiumAmount'] = amount
            resultMap['PaymentAmount'] = amount
            resultMap['premiumAmount'] = amount
        }
        
        if (policy?.PaidToDate) {
            resultMap['PaidToDate'] = policy.PaidToDate.toString()
        }
        
        if (policy?.PaymentMode) {
            resultMap['billingFrequency'] = policy.PaymentMode.toString()
        }
        
        if (policy?.PaymentMethod) {
            resultMap['directBillingMode'] = policy.PaymentMethod.toString()
        }
        
        // Interest Rate from OLifEExtension
        def lifeExtensions = life?.OLifEExtension
        if (lifeExtensions instanceof List) {
            def rateExt = lifeExtensions.find { it?.LifeExtension?.WeightedAvgIntRate != null }
            if (rateExt?.LifeExtension?.WeightedAvgIntRate) {
                resultMap['Interest rate'] = rateExt.LifeExtension.WeightedAvgIntRate.toString()
            }
        } else if (lifeExtensions?.LifeExtension?.WeightedAvgIntRate) {
            resultMap['Interest rate'] = lifeExtensions.LifeExtension.WeightedAvgIntRate.toString()
        }
        
        // Email Address
        if (emailParty?.EMailAddress?.AddrLine) {
            def email = emailParty.EMailAddress.AddrLine.toString()
            resultMap['email Address'] = email
            resultMap['email address'] = email
        }
        
        // Address
        if (party3?.Address) {
            def addr = party3.Address instanceof List ? party3.Address[0] : party3.Address
            def parts = []
            
            if (addr.Line1) parts.add(addr.Line1.toString())
            if (addr.Line2 && addr.Line2.toString().trim()) parts.add(addr.Line2.toString())
            if (addr.Line3 && addr.Line3.toString().trim()) parts.add(addr.Line3.toString())
            if (addr.City) parts.add(addr.City.toString())
            if (addr.AddressState) parts.add(addr.AddressState.toString())
            if (addr.Zip) parts.add(addr.Zip.toString())
            
            if (parts) {
                resultMap['address'] = parts.join(', ')
            }
        }
        
        // User Authentication
        if (userAuth?.TransResult?.ResultCode) {
            resultMap['API for user authentication verification'] = userAuth.TransResult.ResultCode.toString()
        }
        
    } catch (Exception e) {
        println "Error processing XML: ${e.message}"
        e.printStackTrace()
        // Return map with empty strings for all fields
    }
    
    return resultMap
}

// Example usage
def xmlResponse = '''<?xml version="1.0" encoding="UTF-8"?>
<TXLife xmlns="http://ACORD.org/Standards/Life/2">
  <UserAuthResponse xmlns="">
    <TransResult>
      <ResultCode tc="1">The transaction was processed Successfully</ResultCode>
    </TransResult>
  </UserAuthResponse>
  <TXLifeResponse xmlns="">
    <OLifE>
      <Holding id="Holding_1">
        <Policy id="Policy_1">
          <PolicyStatus tc="1">Active (inforce).</PolicyStatus>
          <EffDate>1998-11-23</EffDate>
          <PaidToDate>2025-12-23</PaidToDate>
          <PaymentMode tc="4">MONTHLY</PaymentMode>
          <PaymentMethod tc="26">Pre-Authorized Check</PaymentMethod>
          <Life id="Life_1">
            <LastPremAmt>750</LastPremAmt>
            <LastPremDate>2025-11-03</LastPremDate>
            <CashValueAmt>171575.22</CashValueAmt>
            <NetSurrValueAmt>171575.22</NetSurrValueAmt>
            <Coverage id="Coverage_1">
              <DeathBenefitAmt>500000</DeathBenefitAmt>
            </Coverage>
            <OLifEExtension ExtensionCode="LifeExtension" VendorCode="37">
              <LifeExtension id="LifeExtension_7214">
                <WeightedAvgIntRate>4</WeightedAvgIntRate>
              </LifeExtension>
            </OLifEExtension>
          </Life>
        </Policy>
      </Holding>
      <Party id="Party_3">
        <Address id="Address_2">
          <Line1>73 VILLAGE WALK LANE</Line1>
          <City>PONTE VEDRA BEACH</City>
          <AddressState>FL</AddressState>
          <Zip>32082</Zip>
        </Address>
      </Party>
      <Party id="Party_7">
        <EMailAddress id="EMailAddress_821">
          <AddrLine>SBIA@SBIA.COM</AddrLine>
        </EMailAddress>
      </Party>
    </OLifE>
  </TXLifeResponse>
</TXLife>
'''

// Execute and display results
def result = extractFieldsFromXmlResponse(xmlResponse)

println "Extracted Fields:"
println "="*60
result.each { key, value ->
    println "${key.padRight(45)} : '${value}'"
}

return result
